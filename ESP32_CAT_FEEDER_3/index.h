const char MAIN_page[] PROGMEM = R"=====(
<html>
  <style>
    :root {
      --buttonWidth: 150px;
      --buttonHeight: 50px;
    }

    h4 {
      text-align: center;
    }

    section {
      /* border: 1px solid lightblue; */
      margin: auto;
      width: 100%;
    }

    iframe {
      /* border: 1px solid black; */
      width: 100%;
      height: 400px;
    }

    button {
      /* border: 5px solid lightgray; */
      background-color: rgb(125, 156, 156);
      margin-bottom: 5px;
      width: var(--buttonWidth);
      height: var(--buttonHeight);
      font-weight: bolder;
      position: relative;

    }

    button:hover {
      color: white;
    }

    #stop {
      background-color: red;
    }

    #pause {
      background-color: pink;
    }

    #serial {
      /* border: 1px solid green; */
      background-color: bisque;
    }

    span {
      color: black;
    }

    .sensorsDiv {
      /* border: 1px solid rgb(205, 189, 189); */
      position: relative;
      height: 100%;
      width: 100%;
      margin: auto;
      text-align: center;
    }

    .sensors {
      /* border: 1px solid rgb(202, 196, 196); */
      position: relative;
      width: var(--buttonWidth);
      height: var(--buttonHeight);
      margin: 5px;
      font-weight: bolder;
      text-align: center;
    }

    .buttonDivs {
      /* border: 1px solid rgb(40, 35, 35); */
      display: block;

      position: relative;
      top: 0;
      margin: auto;
      text-align: center;
      margin: 5px;
    }

    .insideDiv {
      margin: 2px;
      display: inline-block;
    }

    #feed {
      background-color: blue;
      color: white;
    }

    #vertical {
      background-color: bisque;
    }

    #reset {
      background-color: black;
      color: white;
    }

    #verticalDown,
    #verticalUp {
      background-color: blueviolet;
    }

    .maintbuttons,
    table,
    tr {
      /* border: 1px solid gray; */
      display: -webkit-box;
      display: -moz-box;
      display: -ms-flexbox;
      display: -webkit-flex;
      display: flex;
    }

    #system {
      display: -webkit-box;
      display: -moz-box;
      display: -ms-flexbox;
      display: -webkit-flex;
      display: flex;
    }

    #verticalupsensor {
      background-color: green;
    }
  </style>

  <head>
    <meta charset="UTF-8"/>
    <meta name"cache-control"="name" cache-control""="cache-control""" content="public, max-age=0">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">

    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css'>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN" crossorigin="anonymous"></script>
    <title>CAT FEEDER 3.0 - Elfege Leylavergne - Smart Home Automation USA - Software Engineering - Robotics</title>

  </head>

  <body>

    <div class="container">
      <div class="row">
        <div class="col-xs-12">
          <center>
            <h1 style="color:blue;">CAT FEEDER 3</h1>
            <h6 id="localip"></h6>
          </center>
        </div>
      </div>
      <div class="row">
        <div class="col-xs-fluid maintbuttons">
          <div class="row sensorsDiv">
            <h1 class="sensors">SENSORS</h1>
            <h4 class="sensors" id="fillstate">fillstate</h4>
            <h4 class="sensors" id="verticalstate">verticalstate</h4>
            <h4 class="sensors" id="canstate">canstate</h4>
            <!-- can detected by impedance sensor -->
            <h4 class="sensors" id="deformation">deformation</h4>
            <h4 class="sensors" id="irval1">irval1</h4>
            <h4 class="sensors" id="irval2">irval2</h4>
          </div>

          <div class="col-xs-fluid maintbuttons">
            <div class="buttonDivs">
              <button class="btn btn-primary m-1" id="feed">FEED</button>
              <button class="btn btn-primary m-1" id="stop">STOP</button>
              <button class="btn btn-primary m-1" id="pause">PAUSE</button>
              <button class="btn btn-primary m-1" id="clean">CLEAN</button>

            </div>
            <div class="buttonDivs">
              <button class="btn btn-primary m-1" id="verticaldown">DOWN</button>
              <button class="btn btn-primary m-1" id="verticalup">UP</button>
              <button class="btn btn-primary m-1" id="verticalstepdown">STEP DOWN</button>
              <button class="btn btn-primary m-1" id="verticalstepup">STEP UP</button>

            </div>
          </div>

          <div class="buttonDivs">
            <button class="btn btn-primary m-1" id="push">PUSH ARM</button>
            <button class="btn btn-primary m-1" id="pull">PULL ARM</button>
            <button class="btn btn-primary m-1" id="load">LOAD A CAN</button>
            <button class="btn btn-primary m-1" id="lock">LOCK</button>
            <button class="btn btn-primary m-1" id="open">OPEN CAN</button>
            <div class="insideDiv" id="openerspeed">
              <span id="sliderValueOpener" class="sliderValue">CAN OPENER'S SPEED</span>
              <input id="sliderOpener" class="slider" type="range" min="0" max="100">
            </div>
          </div>
          <div class="buttonDivs">
            <button class="btn btn-primary m-1" id="extract">EXTRACTION</button>
            <button class="btn btn-primary m-1" id="smallarm">SMALL PUSHER</button>
            <button class="btn btn-primary m-1" id="smallpush">SMALL PUSH</button>
            <button class="btn btn-primary m-1" id="smallpull">SMALL PULL</button>
          </div>

          <div class="buttonDivs">
            <div class="insideDiv" id="cosinusspeed">
              <span id="sliderValueCosinus" for="sliderCosinus" class="sliderValue">ANGLE PUSHER'S SPEED</span>
              <input id="sliderCosinus" class="slider" type="range" min="0" max="100">
            </div>
            <div class="insideDiv">
              <span>ANGLE PUSH - FINE TUNE</span></div>
            <div class="insideDiv">
              <button class="btn btn-primary m-1" id="cosinusplus">+</button>
              <button class="btn btn-primary m-1" id="cosinusminus">-</button>
              <button class="btn btn-primary m-1" id="recordcosmax">record</button>
              <button class="btn btn-primary m-1" id="cosinuspush">ANGLE PUSH</button>
              <button class="btn btn-primary m-1" id="cosinuspull">ANGLE PULL</button>
            </div>
          </div>

          <div id="col-xs-fluid system">
            <div class="buttonDivs">
              <button class="btn btn-primary m-1" id="reset">RESET</button>
              <button class="btn btn-primary m-1" id="logs">DEBUG</button>
              <button class="btn btn-primary m-1" id="term">TERMINAL</button>
              <button class="btn btn-primary m-1" id="toggleIntervals">STOP SCRIPTS</button>
            </div>

          </div>

        </div>
      </div>
      <div class="row">
        <div colspan="col-xs-fluid 3" width="100%">
          <h4 id="serial">Serial Output</h4>
          <iframe id="terminal" hidden="hidden" src="http://192.168.10.241/term.html"></iframe>

        </div>
      </div>
    </div>

  </body>

  <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
  <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://unpkg.com/jquery"></script>

  <script>
    let localIp;
    let Logs = false;

    jQuery(() => {
      $("button").on("click", showTermHandler)
      $("#serial").on("click", showTermHandler)
    })

    function showTermHandler(e) {
      e.preventDefault();
      debug("e.target.getAttribute('id'): ", e.target.getAttribute("id"))
      const id = e
        .target
        .getAttribute("id");
      debug("click event:", id, `id in ["term", "serial"] ? => , ${id in["term", "serial"]}`)
      if (["term", "serial"].find(val => val === id)) {

        const terminal = $("#terminal");
        // console.log("terminal.prop('hidden') ==== ", terminal.prop("hidden") === true)
        if(terminal.prop("hidden") === false){
            terminal.prop("hidden", true);
        }
        else {
            terminal.removeAttr("hidden");
        }
        
        console.log("opening term at: " + localIp)
        terminal.attr("src", `http://${localIp}/term.html`);
      } else {
        mainFunc(e.target.id)
      }
    }

    let scriptOn = false;

    function mainFunc(id) {
      console.log("mainFunc(", id, ")")
      const xhr = new XMLHttpRequest();
      const url = `/${id}`;

      if (id === "logs") {
        Logs = !Logs;
      }

      if (id === "toggleIntervals") {
        if (!scriptOn) {
          $("#toggleIntervals").text("STOP SCRIPTS")
          $("#toggleIntervals").css({"background-color": "blue", "color": "white"})
          resumeIntervals()

        } else if (scriptOn) {
          $("#toggleIntervals").text("RESUME SCRIPTS")
          $("#toggleIntervals").css({"background-color": "red", "color": "white"})
          clearAllIntervals()

        }
        return
      }

      xhr.onreadystatechange = function () {
        if (this.readyState == 4 && this.status == 200) {
          debug(xhr.responseText);
          document
            .getElementById(id)
            .innerText = xhr.responseText;
          if (xhr.responseText === "DEBUG DISABLED") {
            Logs = false;
          }
        }
      };
      xhr.open("GET", url, true);
      xhr.send();

    }

    const ids = []
    const elements = $("*")
    const array = Array.from(elements)
    array.forEach((val) => {
      if ($(val).attr("id") !== undefined) 
        ids.push($(val).attr("id"))
    });

    async function checkStates() {

      const response = await axios({url: "/getstates", method: "GET"});

      const data = response.data;
      debug("checkStates data:" + data);

      const arr = data.split(",")
      const newArr = []
      arr.forEach((val) => {
        newArr.push(val.replace(" ", ":").split(":"))
      })
      const Obj = Object.fromEntries(newArr)
      debug("entries:" + Obj)
      for (let a of Object.keys(Obj)) {
        debug(a + ":" + Obj[a])
        if (a.includes("slider")) {
          $(`#${a}`).val(Obj[a]);
          $(`#sliderValue`).text(Obj[a])
        } else {
          $(`#${a}`).text(Obj[a]);
        }
      }
    }

    function debug(msg) {
      if (Logs) 
        console.log(msg)
    }

    async function getLocalIp() {
      const response = await axios({url: "/getip", method: "GET"});
      console.log("ip response: ", response.data)
      localIp = response.data;
      $("#localip").text(localIp);
    }

    document.addEventListener("DOMContentLoaded", () => {
      sliderEventListeners();
      getLocalIp();

    })

    function sliderEventListeners() {
      const Sliders = $("input")
      const sliderValues = $(".sliderValue")

      const SlidersArray = Array.from(Sliders)
      const SlidersValuesArr = Array.from(sliderValues)

      SlidersArray.forEach((slider, index) => {

        console.log("creating evt listner for", $(slider).attr("class"))
        console.log("slider.class", $(slider).attr("class"))

        $(slider).on("input", (e) => {
          const id = e
            .target
            .id
            console
            .log("input event ", id)
          const xhr = new XMLHttpRequest();
          const url = id + "=" + $(slider).val();
          console.log("sliderValue = ", $(slider).val())
          const name = id
          $(SlidersValuesArr[index]).text(name + "'s speed: " + $(slider).val())

          const response = axios({url: url, method: "GET"});

          // xhr.onreadystatechange = function () {
          // if (this.readyState == 4 && this.status == 200) {
          // console.log("slider response: ", xhr.responseText);
          // $(slider).val(response.data)
          $(e.target.id).val(response.data)
          $(SlidersValuesArr[index]).text(response.data)
          // }
          // };
          // xhr.open("GET", url, true);
          // xhr.send();
        })
      })
    }

    /*
         $(`#${a}`).val(Obj[a]);
                $(`#sliderValue`).text(Obj[a])
    const response = await axios({
            url: "/getstates",
            method: "GET",
        });

        const data = response.data;
        debug("checkStates data:" + data);
        */

    let checkStatesInterval = null;
    let ipRetrieveInterval = null;

    function resumeIntervals() {
      scriptOn = true;
      $("#toggleIntervals").css({"background-color": "blue", "color": "white"})
      console.log("resuming intervals");
      checkStatesInterval = setInterval(checkStates, 1000);
      ipRetrieveInterval = setInterval(getLocalIp, 60 * 60 * 1000);
    }

    resumeIntervals();

    //setTimeout(clearAllIntervals, 60 * 5 * 1000)

    function clearAllIntervals() {
      scriptOn = false;
      console.log("clearing intervals")
      clearInterval(checkStatesInterval);
    }
  </script>

</html>
)=====";